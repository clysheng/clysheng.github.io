<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>CompletableFuture组合式异步编程 | Hexo</title>
  <meta name="description" content="组合式编程的优势 不需要为等待某些服务的响应阻塞应用的运行，充分的利用cpu，通过并行处理，从而最大化程序的吞吐量。 使用CompletableFuture构建异步应用通过一个例子来描述： 背景创建一个名为最佳价格查询器的应用，它会查询多个在线商店，依据给定的产品和服务找出最低价格。 通过代码描述同步和异步的实现区别同步的实现方式1234567891011121314151617181920212">
<meta name="keywords" content="java8">
<meta property="og:type" content="article">
<meta property="og:title" content="CompletableFuture组合式异步编程">
<meta property="og:url" content="http://mrhe.top/2018/01/10/CompletableFuture组合式异步编程/index.html">
<meta property="og:site_name" content="Harvey&#39;s blog">
<meta property="og:description" content="组合式编程的优势 不需要为等待某些服务的响应阻塞应用的运行，充分的利用cpu，通过并行处理，从而最大化程序的吞吐量。 使用CompletableFuture构建异步应用通过一个例子来描述： 背景创建一个名为最佳价格查询器的应用，它会查询多个在线商店，依据给定的产品和服务找出最低价格。 通过代码描述同步和异步的实现区别同步的实现方式1234567891011121314151617181920212">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-02-20T09:16:59.258Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CompletableFuture组合式异步编程">
<meta name="twitter:description" content="组合式编程的优势 不需要为等待某些服务的响应阻塞应用的运行，充分的利用cpu，通过并行处理，从而最大化程序的吞吐量。 使用CompletableFuture构建异步应用通过一个例子来描述： 背景创建一个名为最佳价格查询器的应用，它会查询多个在线商店，依据给定的产品和服务找出最低价格。 通过代码描述同步和异步的实现区别同步的实现方式1234567891011121314151617181920212">
  <!-- Canonical links -->
  <link rel="canonical" href="http://mrhe.top/2018/01/10/CompletableFuture组合式异步编程/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Harvey&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
  
</head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/cofess" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">昵称</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Web Developer &amp; Designer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">Categories</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">Tags</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">Repository</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">Books</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">Links</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/cofess" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mycat/">Mycat</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/springboot/">springboot</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作/">工作</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/摘抄/">摘抄</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mycat/">Mycat</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java8/">java8</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/">jvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mqtt/">mqtt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springboot/">springboot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/学习笔记/">学习笔记</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工作/">工作</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/摘抄/">摘抄</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/触发器/">触发器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/读书笔记/">读书笔记</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Hexo/" style="font-size: 13.33px;">Hexo</a> <a href="/tags/Mycat/" style="font-size: 13.33px;">Mycat</a> <a href="/tags/docker/" style="font-size: 14px;">docker</a> <a href="/tags/java/" style="font-size: 13.33px;">java</a> <a href="/tags/java8/" style="font-size: 13.67px;">java8</a> <a href="/tags/jvm/" style="font-size: 13px;">jvm</a> <a href="/tags/mqtt/" style="font-size: 13px;">mqtt</a> <a href="/tags/redis/" style="font-size: 13px;">redis</a> <a href="/tags/springboot/" style="font-size: 13px;">springboot</a> <a href="/tags/vim/" style="font-size: 13px;">vim</a> <a href="/tags/学习笔记/" style="font-size: 13px;">学习笔记</a> <a href="/tags/工作/" style="font-size: 13.33px;">工作</a> <a href="/tags/工具/" style="font-size: 13px;">工具</a> <a href="/tags/摘抄/" style="font-size: 13px;">摘抄</a> <a href="/tags/触发器/" style="font-size: 13px;">触发器</a> <a href="/tags/读书笔记/" style="font-size: 13.33px;">读书笔记</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/jvm/">jvm</a>
              </p>
              <p class="item-title">
                <a href="/2020/03/08/虚拟机类加载机制/" class="title">虚拟机类加载机制</a>
              </p>
              <p class="item-date">
                <time datetime="2020-03-08T06:26:00.000Z" itemprop="datePublished">2020-03-08</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/docker/">docker</a>
              </p>
              <p class="item-title">
                <a href="/2019/03/20/docker搭建redis-cluster集群/" class="title">docker搭建redis-cluster集群</a>
              </p>
              <p class="item-date">
                <time datetime="2019-03-20T06:00:00.000Z" itemprop="datePublished">2019-03-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Mycat/">Mycat</a>
              </p>
              <p class="item-title">
                <a href="/2019/02/20/Mycat实现读写分离(二)/" class="title">Mycat实现读写分离</a>
              </p>
              <p class="item-date">
                <time datetime="2019-02-20T06:45:00.000Z" itemprop="datePublished">2019-02-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Mycat/">Mycat</a>
              </p>
              <p class="item-title">
                <a href="/2019/02/20/Mycat概述(一)/" class="title">Mycat概述</a>
              </p>
              <p class="item-date">
                <time datetime="2019-02-20T06:45:00.000Z" itemprop="datePublished">2019-02-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/springboot/">springboot</a>
              </p>
              <p class="item-title">
                <a href="/2018/12/25/springboot的jar文件包在linux下启动方式/" class="title">springboot的jar包在linux下启动方式</a>
              </p>
              <p class="item-date">
                <time datetime="2018-12-25T12:05:00.000Z" itemprop="datePublished">2018-12-25</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-CompletableFuture组合式异步编程" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      CompletableFuture组合式异步编程
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2018/01/10/CompletableFuture组合式异步编程/" class="article-date">
	  <time datetime="2018-01-10T13:00:00.000Z" itemprop="datePublished">2018-01-10</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/java/">java</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/java8/">java8</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2018/01/10/CompletableFuture组合式异步编程/#comments" class="article-comment-link">Comments</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>组合式编程的优势</p>
<p>不需要为等待某些服务的响应阻塞应用的运行，充分的利用cpu，通过并行处理，从而最大化程序的吞吐量。</p>
<h2 id="使用CompletableFuture构建异步应用"><a href="#使用CompletableFuture构建异步应用" class="headerlink" title="使用CompletableFuture构建异步应用"></a>使用CompletableFuture构建异步应用</h2><p>通过一个例子来描述：</p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>创建一个名为最佳价格查询器的应用，它会查询多个在线商店，依据给定的产品和服务找出最低价格。</p>
<h3 id="通过代码描述同步和异步的实现区别"><a href="#通过代码描述同步和异步的实现区别" class="headerlink" title="通过代码描述同步和异步的实现区别"></a>通过代码描述同步和异步的实现区别</h3><h4 id="同步的实现方式"><a href="#同步的实现方式" class="headerlink" title="同步的实现方式"></a>同步的实现方式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class Shop &#123;</span><br><span class="line"></span><br><span class="line">    private Random random = new Random() ;</span><br><span class="line"></span><br><span class="line">    public double getPrice(String product)&#123;</span><br><span class="line">        return calculatePrice(product) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 模拟查询延迟</span><br><span class="line">     */</span><br><span class="line">    public static void delay() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1000L);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 随机返回一个价格</span><br><span class="line">     * @param product</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private double calculatePrice(String product) &#123;</span><br><span class="line">        delay();</span><br><span class="line">        return random.nextDouble() * product.charAt(0) + product.charAt(1);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每次查询需要1s，如果同时查询多个商店价格，每一个都要等前一个查询完毕才能执行，耗时过长，而且浪费cpu性能。</p>
<h4 id="异步的实现"><a href="#异步的实现" class="headerlink" title="异步的实现"></a>异步的实现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class ShopSync &#123;</span><br><span class="line">    private Random random = new Random() ;</span><br><span class="line">    /**</span><br><span class="line">     * 创建异步计算对象</span><br><span class="line">     * @param product</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public Future&lt;Double&gt; getPriceAsync(String product) &#123;</span><br><span class="line">        CompletableFuture&lt;Double&gt; futurePrice = new CompletableFuture&lt;&gt;();</span><br><span class="line">            new Thread( () -&gt; &#123;</span><br><span class="line">            double price = calculatePrice(product);</span><br><span class="line">            futurePrice.complete(price);</span><br><span class="line">         &#125;).start();</span><br><span class="line">        return futurePrice;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 模拟查询延迟</span><br><span class="line">     */</span><br><span class="line">    public static void delay() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1000L);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 随机返回一个价格</span><br><span class="line">     * @param product</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private double calculatePrice(String product) &#123;</span><br><span class="line">        delay();</span><br><span class="line">        return random.nextDouble() * product.charAt(0) + product.charAt(1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建了一个代表异步计算的CompletableFuture实例，计算完成时包含计算结果，它创建了另外一个线程去执行计算，而实时返回一个Future实例，但最终结果计算出来，可以通过<strong><em>get</em></strong>方法得到最终结果。</p>
<p>这样做的优势是，当第一家商店的价格未计算出来之前，可以继续查询其它商店价格，应用不会被阻塞。</p>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>如果价格计算过程中产生了错误，会是一个很糟糕的结果，因为提示错误的异常会被限制在试图计算商品价格的当前范围内，最终会杀死该线程，导致等待get方法返回结果的的客户端永久地被阻塞。如何避免呢，实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public Future&lt;Double&gt; getPriceAsync(String product)&#123;</span><br><span class="line">    CompletableFuture&lt;Double&gt; futurePrice = new CompletableFuture&lt;&gt;();</span><br><span class="line">    new Thread(</span><br><span class="line">            () -&gt; &#123;</span><br><span class="line">                try&#123;</span><br><span class="line">                    double price = calculatePrice(product);</span><br><span class="line">                    futurePrice.complete(price);</span><br><span class="line">                &#125;catch (Exception ex)&#123;</span><br><span class="line">                    futurePrice.completeExceptionally(ex) ;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    ).start(); ;</span><br><span class="line">    return futurePrice ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这种方式线程内部会抛出一个<strong><em>Exception</em></strong>异常，客户端不需要一直阻塞下去了，而是得到抛出异常消息。</p>
<h3 id="使用工厂方法supplyAsync创建CompletableFuture"><a href="#使用工厂方法supplyAsync创建CompletableFuture" class="headerlink" title="使用工厂方法supplyAsync创建CompletableFuture"></a>使用工厂方法supplyAsync创建CompletableFuture</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public Future&lt;Double&gt; getPriceAsync(String product) &#123;</span><br><span class="line">        return CompletableFuture.supplyAsync(() -&gt; calculatePrice(product));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>提供了和上面异常处理例子同样的错误管理机制</p>
<h3 id="新背景"><a href="#新背景" class="headerlink" title="新背景"></a>新背景</h3><p>以异步的方式查询多个商店，避免被单一的请求所阻塞，由此提升价格查询器的性能和吞吐量。</p>
<h3 id="代码重构"><a href="#代码重构" class="headerlink" title="代码重构"></a>代码重构</h3><p>首先提供一个商家列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Shop&gt; shops = Arrays.asList(new Shop(&quot;bjshop&quot;),new Shop(&quot;szshop&quot;),new Shop(&quot;gzshop&quot;)) ;</span><br></pre></td></tr></table></figure>
<p>查询所有商品价格，返回一个List列表</p>
<p>采用顺序查询的方式,以stream流的方式实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static List&lt;String&gt; getPrices(String product)&#123;</span><br><span class="line">        List&lt;Shop&gt; shops = Arrays.asList(new Shop(&quot;bjshop&quot;),new Shop(&quot;szshop&quot;),new Shop(&quot;gzshop&quot;),</span><br><span class="line">                new Shop(&quot;cqshop&quot;),new Shop(&quot;hzshop&quot;),new Shop(&quot;njshop&quot;),new Shop(&quot;wqshop&quot;),new Shop(&quot;syshop&quot;)</span><br><span class="line">                ,new Shop(&quot;zzshop&quot;),new Shop(&quot;whshop&quot;),new Shop(&quot;jlshop&quot;)</span><br><span class="line">        ) ;</span><br><span class="line">        return shops.stream().map(</span><br><span class="line">                shop-&gt;String.format(&quot;%s price is %.2f&quot;,shop.getProduct(),shop.getPrice(product))</span><br><span class="line">        ).collect(toList()) ;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>验证该方式的执行性能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">long start = System.nanoTime();</span><br><span class="line">        System.out.println(getPrices(&quot;myPhone27S&quot;));</span><br><span class="line">        long duration = (System.nanoTime() - start) / 1_000_000;</span><br><span class="line">        System.out.println(&quot;Done in &quot; + duration + &quot; msecs&quot;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[bjshop price is 132.83, szshop price is 217.36, gzshop price is 189.29, cqshop price is 202.46, hzshop price is 124.39, njshop price is 170.00, wqshop price is 207.80, syshop price is 127.27, zzshop price is 140.72, whshop price is 145.39, jlshop price is 148.55]</span><br><span class="line">Done in 11161 msecs</span><br></pre></td></tr></table></figure>
<p>采用并行流的方式任然进行该操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static List&lt;String&gt; getPrices(String product)&#123;</span><br><span class="line">        List&lt;Shop&gt; shops = Arrays.asList(new Shop(&quot;bjshop&quot;),new Shop(&quot;szshop&quot;),new Shop(&quot;gzshop&quot;),</span><br><span class="line">                new Shop(&quot;cqshop&quot;),new Shop(&quot;hzshop&quot;),new Shop(&quot;njshop&quot;),new Shop(&quot;wqshop&quot;),new Shop(&quot;syshop&quot;)</span><br><span class="line">                ,new Shop(&quot;zzshop&quot;),new Shop(&quot;whshop&quot;),new Shop(&quot;jlshop&quot;)</span><br><span class="line">        ) ;</span><br><span class="line">        return shops.parallelStream().map(</span><br><span class="line">                shop-&gt;String.format(&quot;%s price is %.2f&quot;,shop.getProduct(),shop.getPrice(product))</span><br><span class="line">        ).collect(toList()) ;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[bjshop price is 172.67, szshop price is 130.66, gzshop price is 128.48, cqshop price is 187.36, hzshop price is 151.71, njshop price is 227.09, wqshop price is 151.64, syshop price is 201.61, zzshop price is 204.35, whshop price is 141.16, jlshop price is 173.75]</span><br><span class="line">Done in 2127 msecs</span><br></pre></td></tr></table></figure>
<p>采用CompletableFuture的方式任然执行该操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public static List&lt;String&gt; getPrices(String product)&#123;</span><br><span class="line">       List&lt;Shop&gt; shops = Arrays.asList(new Shop(&quot;bjshop&quot;),new Shop(&quot;szshop&quot;),new Shop(&quot;gzshop&quot;),</span><br><span class="line">               new Shop(&quot;cqshop&quot;),new Shop(&quot;hzshop&quot;),new Shop(&quot;njshop&quot;),new Shop(&quot;wqshop&quot;),new Shop(&quot;syshop&quot;)</span><br><span class="line">               ,new Shop(&quot;zzshop&quot;),new Shop(&quot;whshop&quot;),new Shop(&quot;jlshop&quot;)</span><br><span class="line">       ) ;</span><br><span class="line">       List&lt;CompletableFuture&lt;String&gt;&gt; priceFutures = shops.stream().map(</span><br><span class="line">               shop -&gt; CompletableFuture.supplyAsync(</span><br><span class="line">                       ()-&gt;shop.getProduct()+&quot; price is&quot;+shop.getPrice(product)</span><br><span class="line">               )</span><br><span class="line">       ).collect(toList()) ;</span><br><span class="line">       return priceFutures.stream().map(CompletableFuture&lt;String&gt;::join).collect(toList()) ;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[bjshop price is227.95307135502128, szshop price is209.0834114771096, gzshop price is180.0509393450812, cqshop price is148.94408809816616, hzshop price is185.99930958873858, njshop price is209.2247143369758, wqshop price is219.53671202996978, syshop price is229.10979442419102, zzshop price is150.8647592512694, whshop price is128.58930830999253, jlshop price is183.3010472086476]</span><br><span class="line">Done in 2097 msecs</span><br></pre></td></tr></table></figure>
<p>这个地方采用两个stream,主要是考虑操作之前的延迟特性，单一的流水线，发向不通商家的请求只能以同步和顺序执行的方式才会成功</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>通过上述三种方式，我们发现，顺训流最慢，但是并行流和CompletableFuture的方式并没有相差很多，主要原因是他们内部是同样通用的线程池，默认使用固定数目的线程，具体线程数可以采用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime. getRuntime().availableProcessors()</span><br></pre></td></tr></table></figure>
<p>查看，CompletableFuture允许对执行器<strong><em>Executor</em></strong>进行配置，尤其是线程池大小，让它以更适合应用需求的方式进行配置，</p>
<h3 id="继续重构"><a href="#继续重构" class="headerlink" title="继续重构"></a>继续重构</h3><p>这次我们使用定制的执行器,继续执行价格查询器的例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public static List&lt;String&gt; getPrices(String product)&#123;</span><br><span class="line">        List&lt;Shop&gt; shops = Arrays.asList(new Shop(&quot;bjshop&quot;),new Shop(&quot;szshop&quot;),new Shop(&quot;gzshop&quot;),</span><br><span class="line">                new Shop(&quot;cqshop&quot;),new Shop(&quot;hzshop&quot;),new Shop(&quot;njshop&quot;),new Shop(&quot;wqshop&quot;),new Shop(&quot;syshop&quot;)</span><br><span class="line">                ,new Shop(&quot;zzshop&quot;),new Shop(&quot;whshop&quot;),new Shop(&quot;jlshop&quot;)</span><br><span class="line">        ) ;</span><br><span class="line">        Executor executor = Executors.newFixedThreadPool(Math.min(shops.size(), 100),</span><br><span class="line">        new ThreadFactory() &#123;</span><br><span class="line">            public Thread newThread(Runnable r) &#123;</span><br><span class="line">                Thread t = new Thread(r);</span><br><span class="line">                t.setDaemon(true);</span><br><span class="line">                return t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        List&lt;CompletableFuture&lt;String&gt;&gt; priceFutures = shops.stream().map(</span><br><span class="line">                shop -&gt; CompletableFuture.supplyAsync(</span><br><span class="line">                        ()-&gt;shop.getProduct()+&quot; price is&quot;+shop.getPrice(product),executor</span><br><span class="line">                )</span><br><span class="line">        ).collect(toList()) ;</span><br><span class="line">        return priceFutures.stream().map(CompletableFuture&lt;String&gt;::join).collect(toList()) ;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[bjshop price is195.2661437963214, szshop price is227.33733741114568, gzshop price is182.76554778672724, cqshop price is217.15629799864445, hzshop price is211.64835186412643, njshop price is203.95503485334427, wqshop price is209.7508691664398, syshop price is165.41938531709016, zzshop price is225.43285716654617, whshop price is144.96966191158535, jlshop price is206.97255470003094]</span><br><span class="line">Done in 1084 msecs</span><br></pre></td></tr></table></figure>
<p>这次我们发现速度提升了，需要注意的是我们创建了一个由守护线程构成的线程池，程序图退出时它会被回收</p>
<h3 id="如何确定执行器线程数目"><a href="#如何确定执行器线程数目" class="headerlink" title="如何确定执行器线程数目"></a>如何确定执行器线程数目</h3><blockquote>
<p>《Java并发编程实战》一书中，Brian Goetz和合著者们为线程池大小的优化提供了不少中肯的建议。这非常重要，如果线程池中线程的数量过多，最终它们会竞争稀缺的处理器和内存资源，浪费大量的时间在上下文切换上。反之，如果线程的数目过少，正如你的应用所面临的情况，处理器的一些核可能就无法充分利用。Brian Goetz建议，线程池大小与处理器的利用率之比可以使用下面的公式进行估算:</p>
<p>Nthreads = NCPU <em> UCPU </em> (1 + W/C)<br>其中:<br>❑NCPU是处理器的核的数目，可以通过Runtime.getRuntime().availableProce-ssors()得到<br>❑UCPU是期望的CPU利用率(该值应该介于0和1之间)<br>❑W/C是等待时间与计算时间的比率</p>
</blockquote>
<h3 id="使用流还是CompletableFuture"><a href="#使用流还是CompletableFuture" class="headerlink" title="使用流还是CompletableFuture"></a>使用流还是CompletableFuture</h3><ul>
<li>如果进行的是计算密集型操作，并且没用I/O，那么推荐使用Stream接口</li>
<li>如果并行的工作单元还涉及等待I/O操作那么使用CompletableFuture接口灵活性</li>
</ul>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://mrhe.top/2018/01/10/CompletableFuture组合式异步编程/" title="CompletableFuture组合式异步编程" target="_blank" rel="external">http://mrhe.top/2018/01/10/CompletableFuture组合式异步编程/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/cofess" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/cofess" target="_blank"><span class="text-dark">昵称</span><small class="ml-1x">Web Developer &amp; Designer</small></a></h3>
        <div>个人简介。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2018/01/16/精力管理/" title="精力管理"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2018/01/10/如何阅读一本书/" title="如何阅读一本书"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>$</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>Maybe you could buy me a cup of coffee.</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="Scan Qrcode" title="Scan" />
              </div>
              <p class="text-muted mv">Scan this qrcode</p>
              <p class="text-grey">Open alipay app scan this qrcode, buy me a coffee!</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="Scan Qrcode" title="Scan" />
              </div>
              <p class="text-muted mv">Scan this qrcode</p>
              <p class="text-grey">Open wechat app scan this qrcode, buy me a coffee!</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> alipay</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> wechat payment</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/cofess" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/cofess" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com/iwebued" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="https://www.behance.net/cofess" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>